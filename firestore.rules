rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidCampaign() {
      return request.resource.data.keys().hasAll(['campaignName', 'slug', 'visibility', 'frameURL', 'status', 'createdBy', 'supportersCount']) &&
             request.resource.data.campaignName is string &&
             request.resource.data.campaignName.size() > 0 &&
             request.resource.data.campaignName.size() <= 100 &&
             request.resource.data.slug is string &&
             request.resource.data.slug.matches('^[a-z0-9-]+$') &&
             request.resource.data.slug.size() > 0 &&
             request.resource.data.slug.size() <= 100 &&
             request.resource.data.visibility in ['Public', 'Unlisted'] &&
             request.resource.data.frameURL is string &&
             request.resource.data.frameURL.matches('^https://.*') &&
             request.resource.data.status in ['Active', 'Inactive'] &&
             request.resource.data.supportersCount is int &&
             request.resource.data.supportersCount >= 0;
    }
    
    function isValidUser() {
      return request.resource.data.keys().hasAll(['uid', 'email']) &&
             request.resource.data.uid is string &&
             request.resource.data.email is string &&
             request.resource.data.email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function isValidUsername() {
      return !request.resource.data.keys().hasAny(['username']) ||
             (request.resource.data.username is string &&
              request.resource.data.username.size() >= 3 &&
              request.resource.data.username.size() <= 30 &&
              request.resource.data.username.matches('^[a-zA-Z0-9_-]+$'));
    }
    
    // Check if user is admin (via custom claim)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.isAdmin == true;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles (for displaying creator info and public profiles)
      allow read: if true;
      
      // Only the user can create their own profile
      allow create: if isOwner(userId) && isValidUser() && isValidUsername();
      
      // Only the user can update their own profile
      // IMPORTANT: Cannot modify freeCampaignUsed from client
      allow update: if isOwner(userId) && 
                      isValidUser() && 
                      isValidUsername() &&
                      // Prevent modification of freeCampaignUsed field
                      !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['freeCampaignUsed']);
      
      // Only the user can delete their own profile
      allow delete: if isOwner(userId);
    }
    
    // Campaigns collection
    match /campaigns/{campaignId} {
      // Anyone can read public campaigns
      allow read: if true;
      
      // Only authenticated users can create campaigns
      allow create: if isAuthenticated() && 
                      isOwner(request.resource.data.createdBy) &&
                      isValidCampaign();
      
      // Only the campaign owner can update their campaign
      // IMPORTANT: Cannot modify payment-related fields and isFreeCampaign from client
      allow update: if isAuthenticated() && 
                      isOwner(resource.data.createdBy) &&
                      isValidCampaign() &&
                      // Prevent changing the owner
                      request.resource.data.createdBy == resource.data.createdBy &&
                      // Prevent modification of payment fields and free campaign flag
                      !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['isActive', 'expiresAt', 'planType', 'amountPaid', 'paymentId', 'lastPaymentAt', 'isFreeCampaign']);
      
      // Allow anyone to update supportersCount (for tracking supporters)
      // This is needed for the supporters API to work
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['supportersCount']) &&
                      request.resource.data.supportersCount is int &&
                      request.resource.data.supportersCount >= 0 &&
                      request.resource.data.supportersCount > resource.data.supportersCount;
      
      // Only the campaign owner can delete their campaign
      allow delete: if isAuthenticated() && isOwner(resource.data.createdBy);
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Only system can create notifications (via server-side code)
      allow create: if false;
      
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && 
                      isOwner(resource.data.userId) &&
                      // Only allow updating isRead field
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']) &&
                      request.resource.data.isRead is bool;
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Payment records - read-only for users
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow write: if false; // Only server can write
    }
    
    // Expiry logs - read-only for users
    match /expiryLogs/{logId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow write: if false; // Only server can write
    }
    
    // Campaign Stats Daily collection
    match /CampaignStatsDaily/{statId} {
      // Anyone can read stats (for public analytics)
      allow read: if true;
      
      // Anyone can create/update stats (for tracking visits and downloads)
      // In production, consider using Cloud Functions for more secure tracking
      allow create, update: if request.resource.data.keys().hasAll(['campaignId', 'date', 'visits', 'downloads']) &&
                               request.resource.data.campaignId is string &&
                               request.resource.data.date is string &&
                               request.resource.data.date.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$') &&
                               request.resource.data.visits is int &&
                               request.resource.data.visits >= 0 &&
                               request.resource.data.downloads is int &&
                               request.resource.data.downloads >= 0;
      
      // No one can delete stats
      allow delete: if false;
    }
    
    // Admin logs collection - only admins can access
    match /logs/{logId} {
      allow read, write: if isAdmin();
    }
    
    // Cleanup logs collection - only admins can access
    match /cleanupLogs/{logId} {
      allow read, write: if isAdmin();
    }
    
    // Settings collection - pricing is public, system settings require auth, only admins can write
    match /settings/plans {
      allow read: if true; // Public pricing
      allow write: if isAdmin();
    }
    
    match /settings/{document} {
      allow read: if document == 'system' ? true : isAuthenticated(); // System settings public for feature flags
      allow write: if isAdmin();
    }
    
    // Supporters collection - tracks who supported which campaigns
    match /supporters/{supporterId} {
      // Anyone can read supporter records (for public stats)
      allow read: if true;
      
      // Anyone can create supporter records (for tracking downloads)
      // Validation ensures data integrity
      allow create: if request.resource.data.keys().hasAll(['campaignId', 'sessionId', 'supportedAt', 'downloadCount']) &&
                      request.resource.data.campaignId is string &&
                      request.resource.data.sessionId is string &&
                      request.resource.data.downloadCount is int &&
                      request.resource.data.downloadCount > 0 &&
                      // Optional fields validation
                      (!request.resource.data.keys().hasAny(['userId']) || request.resource.data.userId is string) &&
                      (!request.resource.data.keys().hasAny(['userEmail']) || request.resource.data.userEmail is string) &&
                      (!request.resource.data.keys().hasAny(['ipAddress']) || request.resource.data.ipAddress is string) &&
                      (!request.resource.data.keys().hasAny(['userAgent']) || request.resource.data.userAgent is string);
      
      // Only allow updating download count and last download time
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['downloadCount', 'lastDownloadAt']) &&
                      request.resource.data.downloadCount is int &&
                      request.resource.data.downloadCount > resource.data.downloadCount;
      
      // Only admins can delete supporter records
      allow delete: if isAdmin();
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
